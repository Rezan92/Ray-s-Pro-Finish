# Feature Specification: Painting Man-Hour Pricing Refactor

**Feature Branch**: `008-painting-man-hour-pricing-refactor`
**Created**: 2026-02-06
**Status**: Draft
**Input**: User description: "Create a feature specification for 'Painting Man-Hour Pricing Refactor'. The goal is to replace the current flat-rate painting estimator with a granular man-hour calculation engine based on PCA standards. Key requirements: 1. Frontend: Update the Painting Estimator UI to support 'Global Defaults' (apply to all rooms) vs 'Room Overrides'. Add an 'Exact Dimensions' option (Width/Length inputs) alongside S/M/L presets. 2. Backend: Implement a robust calculation engine that derives time from surface area, production rates (e.g., 400 SFPH rolling), and multipliers (Occupancy, Ceiling Height). 3. Logic: Implement specific rules for 'Daily Trip Constants' (45m/day), 'Setup/Masking' (auto-added per room), and 'Occupancy Factors'. 4. Output: The API must return a final price AND a highly detailed 'Admin Summary' breaking down every minute charged (e.g., 'Living Room: 12m Masking, 2.5h Rolling'). It should also integrate with Gemini API to generate a user-friendly summary message."

## Clarifications

### Session 2026-02-06
- Q: If the user omits height in "Exact Dimensions" mode, should we default to a standard value? → A: Standard Height - Assume 8ft (Multiplier 1.0x) if height is missing.
- Q: Is the Admin Summary AI-generated? → A: **No.** The Admin Summary is a deterministic table generated by the backend logic. AI (Gemini) is used *only* to transform the calculation data into a friendly summary message for the customer.
- Q: What are the requirements for the Admin Summary display? → A: It must be a 4-column table: `Item/Surface`, `Price`, `Time`, and `Details`. The 'Details' column must show the specific math/logic (e.g., production rates and multipliers used).
- Q: How should pricing be managed for the calculation engine? → A: **Centralized $75/hr Rate.** All labor calculations must derive from a single "Base Hourly Rate" constant (set to $75) in `masterRates.ts`. Updating this one variable must update the entire system.
- Q: How should the estimate data be returned? → A: **Structured JSON.** Instead of plain text strings, the backend must return an array of breakdown objects. This enables the Admin Table and provides high-quality context for the AI User Summary.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Advanced Painting Configuration (Priority: P1)

As a user, I want to define global preferences for my painting project (e.g., "Paint Walls & Ceiling in every room") while retaining the ability to customize individual rooms, so that I can quickly build an accurate estimate without repetitive data entry.

**Independent Test**: Configure a project with global "Walls + Ceiling", add 3 rooms, then override one room to be "Walls Only". Verify the state reflects this hierarchy.

---

### User Story 2 - Man-Hour Calculation Engine (Priority: P2)

As an admin/business owner, I want the system to calculate pricing based on precise man-hour production rates (e.g., SFPH for rolling, LFPH for cutting) and a base hourly rate, so that estimates are accurate and defensible based on industry standards (PCA).

**Independent Test**: Submit a payload with known dimensions and surface types. Verify the returned price matches the expected manual calculation: `(Total Man Hours * $75/hr) + Materials`.

---

### User Story 3 - Transparent & Persuasive Summaries (Priority: P3)

As an admin, I want to see exactly how the price was built, and as a customer, I want a professional, value-driven summary that explains what I'm paying for without overwhelming me with raw math.

**Independent Test**: Verify the API returns a structured breakdown array for the admin table and a persuasive, non-granular message for the user.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: The UI MUST support "Global Defaults" state that propagates to new rooms.
- **FR-002**: The UI MUST allow individual rooms to override global defaults via a specific toggle/interaction.
- **FR-003**: The UI MUST provide "Exact Dimensions" inputs (Width, Length) when selected in the size dropdown.
- **FR-004**: The backend MUST calculate "Daily Trip Constants" based on `ceil(Total Man-Hours / 8) * 45 minutes`.
- **FR-005**: The backend MUST automatically add "Room Default" times: 10 min masking (window+fixture), 12 min electrical (4 plates), 15 min/100sf floor protection.
- **FR-006**: The backend MUST apply "Occupancy Factors" (1.0x, 1.20x, 1.35x) and "Ceiling Height Factors" (1.0x - 1.45x) to applicable labor.
- **FR-007**: The backend MUST return a detailed `adminSummary` as a structured JSON array (Surface, Price, Time, Details).
- **FR-008**: The backend MUST integrate with the Gemini API using a "High Conversion" blueprint that focuses on value-added services and timeline, while hiding granular line-item costs.
- **FR-009**: The system MUST default to 8ft height (Multiplier 1.0x) for calculation purposes if "Exact Dimensions" are provided without a specific height selection.
- **FR-010**: All pricing MUST derive from a central `HOURLY_LABOR_RATE` constant (default $75) in `masterRates.ts`.

### Key Entities *(include if feature involves data)*

- **ProductionRates**: `{ rolling1stCoat: 400, rolling2ndCoat: 550, cuttingStandard: 120, ... }`
- **BreakdownItem**: `{ surface: string, price: number, timeMinutes: number, details: string, hours: number }`
- **UserMessage**: High-conversion AI-generated text.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% of painting estimates are generated using the new Man-Hour formula.
- **SC-002**: Admin summary table correctly populates all 4 columns for every labor item.
- **SC-003**: User summary message is generated via Gemini API and contains 0 references to per-square-foot pricing.
- **SC-004**: Changing the `$75` constant in the backend updates the price of all subsequent estimates.